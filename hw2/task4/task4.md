## Задание 4. NUMA и cgroups.

### Демонстрация кол-ва NUMA-нод

Для демонстрации количества NUMA-нод на устройстве выполним команду:

```shell
numactl -H
```

Вывод команды:

```
available: 1 nodes (0)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
node 0 size: 15770 MB
node 0 free: 281 MB
node distances:
node   0 
  0:  10
```

Из вывода видно, что на машине присутствует 1 NUMA-нода на ~16Gb

### Ограничение работы процессов при помощи systemd

**MemoryMax** - устанавливает максимальный лимит физической памяти (RAM) для юнита.

**CPUWeight** устанавливает относительный приоритет доступа к CPU времени. Например, если сервис A имеет weight=200, а сервис B weight=100, то A получит в 2 раза больше CPU времени

Для ограничения памяти и CPU для процессов используем следующую команду:

```shell
sudo systemd-run --unit=highload-stress-test --slice=testing.slice -p "MemoryMax=150M" -p "CPUWeight=100" stress --cpu 1 --vm 1 --vm-bytes 300M --timeout 30s
```

Здесь мы с помощью `systemd-run` сначала задаем ограничения, а затем запускаем процесс использующий их.

Мониторинг процесса был выполнен с помощью следующей команды:

```shell
systemd-cgtop /testing.slice
```

Вывод:

```shell
Control Group                                                                                                                                                                       Tasks   %CPU   Memory  Input/s Output/s
/testing.slice                                                                                                                                                                          3  195.5   150.0M    14.8M    25.5M
/testing.slice/highload-stress-test.service                                                                                                                                             3  195.5   149.9M        -        -
```

Видно, что несмотря на явное указание запрашиваемой памяти в размере 300Mb, процесс работает используя лишь 150, в соответствии с ограничениями. Так работает при любом превышающем значении запрашиваемой памяти - все ограничивается значением `MemoryMax`. Если же, есть цель останавливать процесс при превышении, следует использовать `MemoryLimit` вместо `MemoryMax`.
